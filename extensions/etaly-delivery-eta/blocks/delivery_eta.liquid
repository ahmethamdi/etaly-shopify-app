{% comment %}
  ETAly - Delivery ETA Display Block
  Shows estimated delivery date on product pages
{% endcomment %}

<div
  class="etaly-delivery-eta"
  data-etaly-block
  data-product-id="{{ product.id }}"
  data-variant-id="{{ product.selected_or_first_available_variant.id }}"
  data-style="{{ block.settings.style }}"
  data-show-icon="{{ block.settings.show_icon }}"
  data-icon="{{ block.settings.icon }}"
  data-show-cutoff="{{ block.settings.show_cutoff_timer }}"
>
  <div class="etaly-eta-loading">
    <svg class="etaly-spinner" width="20" height="20" viewBox="0 0 20 20">
      <circle cx="10" cy="10" r="8" stroke="currentColor" stroke-width="2" fill="none" stroke-dasharray="50" stroke-dashoffset="0">
        <animateTransform attributeName="transform" type="rotate" from="0 10 10" to="360 10 10" dur="1s" repeatCount="indefinite"/>
      </circle>
    </svg>
    <span>Calculating delivery estimate...</span>
  </div>

  <div class="etaly-eta-content" style="display: none;">
    {% if block.settings.show_icon %}
      <span class="etaly-eta-icon" data-icon-type="{{ block.settings.icon_type }}">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          {% if block.settings.icon_type == 'truck' %}
            <rect x="1" y="3" width="15" height="13"></rect>
            <polygon points="16 8 20 8 23 11 23 16 16 16 16 8"></polygon>
            <circle cx="5.5" cy="18.5" r="2.5"></circle>
            <circle cx="18.5" cy="18.5" r="2.5"></circle>
          {% elsif block.settings.icon_type == 'package' %}
            <line x1="16.5" y1="9.4" x2="7.5" y2="4.21"></line>
            <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
            <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
            <line x1="12" y1="22.08" x2="12" y2="12"></line>
          {% elsif block.settings.icon_type == 'plane' %}
            <path d="M21 16v-2l-8-5V3.5a1.5 1.5 0 0 0-3 0V9l-8 5v2l8-2.5V19l-2 1.5V22l3.5-1 3.5 1v-1.5L13 19v-5.5l8 2.5z"></path>
          {% else %}
            <rect x="1" y="3" width="15" height="13"></rect>
            <polygon points="16 8 20 8 23 11 23 16 16 16 16 8"></polygon>
            <circle cx="5.5" cy="18.5" r="2.5"></circle>
            <circle cx="18.5" cy="18.5" r="2.5"></circle>
          {% endif %}
        </svg>
      </span>
    {% endif %}
    <div class="etaly-eta-message">
      <span class="etaly-eta-text"></span>
      {% if block.settings.show_cutoff_timer %}
        <span class="etaly-cutoff-timer" style="display: none;"></span>
      {% endif %}
    </div>
  </div>

  <div class="etaly-eta-error" style="display: none;">
    <span>Unable to calculate delivery estimate</span>
  </div>
</div>

<style>
@keyframes etaly-fade-in {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes etaly-shimmer {
  0% { background-position: -200% 0; }
  100% { background-position: 200% 0; }
}

@keyframes etaly-pulse {
  0%, 100% { transform: scale(1); opacity: 1; }
  50% { transform: scale(1.05); opacity: 0.9; }
}

.etaly-delivery-eta {
  margin: 20px 0;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
}

.etaly-eta-loading {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 14px 20px;
  background: linear-gradient(135deg, rgba(243, 244, 246, 0.95) 0%, rgba(229, 231, 235, 0.95) 100%);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  border-radius: 14px;
  border: 1px solid rgba(209, 213, 219, 0.3);
  color: #6b7280;
  font-size: 14px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05), 0 0 0 1px rgba(255, 255, 255, 0.1) inset;
}

.etaly-spinner {
  flex-shrink: 0;
  color: #6b7280;
  animation: etaly-pulse 1.5s ease-in-out infinite;
}

.etaly-eta-content {
  display: none;
  align-items: center;
  gap: 14px;
  padding: 16px 22px;
  border-radius: 16px;
  font-size: 14px;
  font-weight: 500;
  transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  animation: etaly-fade-in 0.5s ease-out;
  position: relative;
  overflow: hidden;
}

.etaly-eta-content::before {
  content: '';
  position: absolute;
  top: 0;
  left: -200%;
  width: 200%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(139, 92, 246, 0.15), transparent);
  animation: etaly-shimmer 4s infinite;
  pointer-events: none;
}

.etaly-eta-icon {
  flex-shrink: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  width: 40px;
  height: 40px;
  border-radius: 10px;
  transition: transform 0.3s ease;
}

.etaly-eta-content:hover .etaly-eta-icon {
  transform: scale(1.1) rotate(5deg);
}

.etaly-eta-icon svg {
  width: 24px;
  height: 24px;
  stroke-width: 2.5;
  filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
}

.etaly-eta-message {
  display: flex;
  flex-direction: column;
  gap: 4px;
  flex: 1;
}

.etaly-eta-text {
  font-weight: 600;
  font-size: 15px;
  letter-spacing: 0.3px;
  line-height: 1.5;
  text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
}

.etaly-cutoff-timer {
  font-size: 12px;
  font-weight: 500;
  opacity: 0.85;
  letter-spacing: 0.2px;
}

.etaly-eta-error {
  display: none;
  padding: 14px 20px;
  background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
  border: 1px solid rgba(248, 113, 113, 0.3);
  border-radius: 14px;
  color: #dc2626;
  font-size: 14px;
  font-weight: 500;
  box-shadow: 0 4px 12px rgba(220, 38, 38, 0.1);
}

/* UNIFIED MODERN STYLE - All themes use same premium black design */
.etaly-style-info .etaly-eta-content,
.etaly-style-success .etaly-eta-content,
.etaly-style-warning .etaly-eta-content {
  background: linear-gradient(135deg, rgba(17, 24, 39, 0.97) 0%, rgba(31, 41, 55, 0.97) 100%);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  color: #ffffff;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3),
              0 0 0 1px rgba(255, 255, 255, 0.05) inset,
              0 0 20px rgba(139, 92, 246, 0.1);
}

.etaly-style-info .etaly-eta-icon,
.etaly-style-success .etaly-eta-icon,
.etaly-style-warning .etaly-eta-icon {
  background: linear-gradient(135deg, rgba(139, 92, 246, 0.2) 0%, rgba(109, 40, 217, 0.2) 100%);
  box-shadow: 0 0 20px rgba(139, 92, 246, 0.3);
  border: 1px solid rgba(139, 92, 246, 0.3);
}

.etaly-style-info .etaly-eta-icon svg,
.etaly-style-success .etaly-eta-icon svg,
.etaly-style-warning .etaly-eta-icon svg {
  stroke: #a78bfa;
  filter: drop-shadow(0 0 8px rgba(167, 139, 250, 0.5));
}

@media (max-width: 768px) {
  .etaly-delivery-eta {
    margin: 12px 0;
  }
  .etaly-eta-content,
  .etaly-eta-loading {
    padding: 10px 14px;
    font-size: 13px;
  }
  .etaly-eta-icon {
    font-size: 18px;
  }
  .etaly-cutoff-timer {
    font-size: 11px;
  }
}

@keyframes etaly-fade-in {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.etaly-eta-content {
  animation: etaly-fade-in 0.3s ease-out;
}
</style>

<script>
(function() {
  'use strict';

  const API_ENDPOINT = '/apps/etaly/api/storefront/calculate-eta';

  // Get or create session ID for analytics tracking
  function getSessionId() {
    let sessionId = sessionStorage.getItem('etaly_session_id');
    if (!sessionId) {
      sessionId = 'etaly_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
      sessionStorage.setItem('etaly_session_id', sessionId);
    }
    return sessionId;
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }

  function init() {
    const blocks = document.querySelectorAll('[data-etaly-block]');
    blocks.forEach(block => initBlock(block));
  }

  async function initBlock(block) {
    const productId = block.dataset.productId;
    const variantId = block.dataset.variantId;
    const style = block.dataset.style || 'success';
    const showCutoff = block.dataset.showCutoff === 'true';

    if (!productId) {
      showError(block);
      return;
    }

    try {
      const countryCode = await getCustomerCountry();
      block.dataset.countryCode = countryCode; // Store for click tracking

      const eta = await fetchETA({
        productId,
        variantId,
        countryCode
      });

      if (eta && eta.success) {
        displayETA(block, eta.eta, style, showCutoff);
        trackImpression(productId, variantId, eta.eta.ruleId, countryCode);
      } else {
        showError(block);
      }
    } catch (error) {
      console.error('ETAly: Error fetching delivery estimate', error);
      showError(block);
    }
  }

  async function fetchETA(params) {
    const formData = new FormData();
    formData.append('productId', params.productId);
    formData.append('variantId', params.variantId);
    formData.append('countryCode', params.countryCode);

    const response = await fetch(API_ENDPOINT, {
      method: 'POST',
      body: formData,
      headers: {
        'X-Requested-With': 'XMLHttpRequest'
      }
    });

    if (!response.ok) {
      throw new Error('Failed to fetch ETA');
    }

    return await response.json();
  }

  function displayETA(block, eta, style, showCutoff) {
    const loadingEl = block.querySelector('.etaly-eta-loading');
    const contentEl = block.querySelector('.etaly-eta-content');
    const textEl = block.querySelector('.etaly-eta-text');
    const cutoffEl = block.querySelector('.etaly-cutoff-timer');

    loadingEl.style.display = 'none';
    contentEl.style.display = 'flex';
    textEl.textContent = eta.message;
    block.classList.add(`etaly-style-${style}`);

    if (showCutoff && cutoffEl && eta.cutoffTime) {
      cutoffEl.style.display = 'inline';
      startCutoffTimer(cutoffEl, eta.cutoffTime);
    }

    // Add click tracking
    contentEl.style.cursor = 'pointer';
    contentEl.addEventListener('click', function() {
      trackClick(block.dataset.productId, block.dataset.variantId, eta.ruleId, block.dataset.countryCode);
    });
  }

  function showError(block) {
    const loadingEl = block.querySelector('.etaly-eta-loading');
    const errorEl = block.querySelector('.etaly-eta-error');
    loadingEl.style.display = 'none';
    errorEl.style.display = 'block';
  }

  async function getCustomerCountry() {
    if (typeof Shopify !== 'undefined' && Shopify.country) {
      return Shopify.country;
    }
    if (typeof Shopify !== 'undefined' && Shopify.Checkout && Shopify.Checkout.country) {
      return Shopify.Checkout.country;
    }
    try {
      const response = await fetch('/api/storefront/detect-country');
      const data = await response.json();
      return data.countryCode || 'US';
    } catch (error) {
      console.warn('ETAly: Could not detect country, defaulting to US');
      return 'US';
    }
  }

  function startCutoffTimer(element, cutoffTime) {
    const [hours, minutes] = cutoffTime.split(':').map(Number);

    function updateTimer() {
      const now = new Date();
      const cutoff = new Date();
      cutoff.setHours(hours, minutes, 0, 0);

      if (now > cutoff) {
        element.textContent = 'Order by tomorrow for next-day delivery';
        return;
      }

      const diff = cutoff - now;
      const hoursLeft = Math.floor(diff / (1000 * 60 * 60));
      const minutesLeft = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
      element.textContent = `Order within ${hoursLeft}h ${minutesLeft}m for same-day processing`;
    }

    updateTimer();
    setInterval(updateTimer, 60000);
  }

  function trackImpression(productId, variantId, ruleId, countryCode) {
    const trackData = new FormData();
    trackData.append('eventType', 'impression');
    trackData.append('sessionId', getSessionId());
    trackData.append('productId', productId);
    trackData.append('variantId', variantId);
    trackData.append('ruleId', ruleId);
    trackData.append('countryCode', countryCode);
    trackData.append('pageType', 'product');

    fetch('/api/storefront/track', {
      method: 'POST',
      body: trackData,
      headers: {
        'X-Requested-With': 'XMLHttpRequest'
      }
    }).catch(err => {
      console.warn('ETAly: Failed to track impression', err);
    });
  }

  function trackClick(productId, variantId, ruleId, countryCode) {
    const trackData = new FormData();
    trackData.append('eventType', 'click');
    trackData.append('sessionId', getSessionId());
    trackData.append('productId', productId);
    trackData.append('variantId', variantId);
    trackData.append('ruleId', ruleId);
    trackData.append('countryCode', countryCode);
    trackData.append('pageType', 'product');

    fetch('/api/storefront/track', {
      method: 'POST',
      body: trackData,
      headers: {
        'X-Requested-With': 'XMLHttpRequest'
      }
    }).catch(err => {
      console.warn('ETAly: Failed to track click', err);
    });
  }

  if (typeof Shopify !== 'undefined') {
    document.addEventListener('change', function(e) {
      if (e.target.name === 'id' || e.target.classList.contains('product-form__variant')) {
        const blocks = document.querySelectorAll('[data-etaly-block]');
        blocks.forEach(block => {
          block.dataset.variantId = e.target.value;
          initBlock(block);
        });
      }
    });

    // Intercept add to cart to include sessionId
    document.addEventListener('submit', function(e) {
      const form = e.target;
      if (form.getAttribute('action')?.includes('/cart/add') ||
          form.querySelector('[name="add"]') ||
          form.classList.contains('product-form')) {

        // Add sessionId as hidden input
        let sessionInput = form.querySelector('input[name="attributes[etaly_session_id]"]');
        if (!sessionInput) {
          sessionInput = document.createElement('input');
          sessionInput.type = 'hidden';
          sessionInput.name = 'attributes[etaly_session_id]';
          form.appendChild(sessionInput);
        }
        sessionInput.value = getSessionId();
      }
    });

    // Intercept AJAX add to cart (modern themes)
    const originalFetch = window.fetch;
    window.fetch = function(...args) {
      const [url, options] = args;

      // Check if this is an add to cart request
      if (typeof url === 'string' && url.includes('/cart/add')) {
        if (options && options.body) {
          try {
            // Handle FormData
            if (options.body instanceof FormData) {
              options.body.append('attributes[etaly_session_id]', getSessionId());
            }
            // Handle JSON
            else if (typeof options.body === 'string') {
              const data = JSON.parse(options.body);
              if (!data.attributes) {
                data.attributes = {};
              }
              data.attributes.etaly_session_id = getSessionId();
              options.body = JSON.stringify(data);
            }
          } catch (err) {
            console.warn('ETAly: Could not add sessionId to cart', err);
          }
        }
      }

      return originalFetch.apply(this, args);
    };
  }
})();
</script>

{% schema %}
{
  "name": "Delivery ETA",
  "target": "section",
  "settings": [
    {
      "type": "checkbox",
      "id": "show_icon",
      "label": "Show icon",
      "default": true
    },
    {
      "type": "select",
      "id": "icon_type",
      "label": "Icon type",
      "options": [
        {
          "value": "truck",
          "label": "Delivery Truck"
        },
        {
          "value": "package",
          "label": "Package Box"
        },
        {
          "value": "plane",
          "label": "Airplane (Express)"
        }
      ],
      "default": "truck"
    },
    {
      "type": "select",
      "id": "style",
      "label": "Message style",
      "options": [
        {
          "value": "info",
          "label": "Info (Blue)"
        },
        {
          "value": "success",
          "label": "Success (Green)"
        },
        {
          "value": "warning",
          "label": "Warning (Orange)"
        }
      ],
      "default": "success"
    },
    {
      "type": "checkbox",
      "id": "show_cutoff_timer",
      "label": "Show cutoff timer",
      "default": true
    }
  ]
}
{% endschema %}
